---
/**
 * GravatarAvatar Component
 *
 * Displays a Gravatar avatar for a given email address with extensive customization options.
 *
 * @example
 * ```astro
 * import GravatarAvatar from 'astro-gravatar/GravatarAvatar';
 *
 * <GravatarAvatar email="user@example.com" size={100} />
 *
 * <GravatarAvatar
 *   email="user@example.com"
 *   size={150}
 *   rating="pg"
 *   default="identicon"
 *   class="rounded-full"
 * />
 * ```
 */

import { buildAvatarUrl, validateAvatarParams, getDefaultAvatarConfig } from '../lib/gravatar.js';
import type { GravatarAvatarProps, AvatarRating, DefaultAvatar } from '../lib/types.js';

interface Props {
  /** Email address to generate avatar for */
  email: string;
  /** Avatar size in pixels (1-2048) @default 80 */
  size?: number;
  /** Maximum rating level allowed (g, pg, r, x) @default 'g' */
  rating?: AvatarRating;
  /** Default image to use when no avatar is found */
  default?: DefaultAvatar;
  /** Whether to force default image */
  forceDefault?: boolean;
  /** CSS class for the avatar image */
  class?: string;
  /** Alt text for the image */
  alt?: string;
  /** Whether to enable lazy loading @default false */
  lazy?: boolean;
}

const {
  email,
  size = 80,
  rating,
  default: defaultImage,
  forceDefault,
  class: className,
  alt,
  lazy = false,
}: Props = Astro.props;

// Validate parameters
validateAvatarParams(size, rating);

// Get default configuration
const defaultConfig = getDefaultAvatarConfig();

// Build avatar URL
const avatarUrl = await buildAvatarUrl(email, {
  size: size || defaultConfig.size,
  rating: rating || defaultConfig.rating,
  default: defaultImage || defaultConfig.default,
  forceDefault,
});

// Generate alt text
const altText = alt || `Avatar for ${email}`;

// Generate loading attribute
const loadingAttr = lazy ? 'lazy' : 'eager';

// Generate srcset for responsive images
const generateSrcset = async (baseSize: number) => {
  const sizes = [1, 1.5, 2];
  const srcPromises = sizes.map(async scale => {
      const scaledSize = Math.round(baseSize * scale);
      const maxSize = 2048;
      if (scaledSize > maxSize) return null;

      const scaledUrl = await buildAvatarUrl(email, {
        size: scaledSize,
        rating: rating || defaultConfig.rating,
        default: defaultImage || defaultConfig.default,
        forceDefault,
      });

      return `${scaledUrl} ${scale}x`;
  });

  const results = await Promise.all(srcPromises);
  return results.filter(Boolean).join(', ');
};

const srcset = size ? await generateSrcset(size) : undefined;

// Generate sizes attribute for responsive images
const sizesAttr = size ? `(max-width: 768px) ${Math.min(size, 80)}px, ${size}px` : undefined;
---

<div class="gravatar-avatar-wrapper" data-lazy={lazy ? 'true' : 'false'}>
  {lazy && (
    <div class="lazy-placeholder" style={{
      width: size + 'px',
      height: size + 'px',
      borderRadius: className?.includes('rounded-full') ? '50%' : className?.includes('rounded') ? '0.25rem' : '0'
    }}></div>
  )}
  <img
    src={avatarUrl}
    srcset={srcset}
    sizes={sizesAttr}
    width={size}
    height={size}
    alt={altText}
    class:list={['gravatar-avatar', className]}
    loading={loadingAttr}
    decoding="async"
  />
</div>

{lazy && (
  <script>
    function initLazyAvatars() {
      const wrappers = document.querySelectorAll('.gravatar-avatar-wrapper[data-lazy="true"]');
      
      wrappers.forEach(wrapper => {
        if (wrapper.hasAttribute('data-initialized')) return;
        wrapper.setAttribute('data-initialized', 'true');

        const img = wrapper.querySelector('img');
        const placeholder = wrapper.querySelector('.lazy-placeholder');

        if (img && placeholder) {
          // Check if already loaded
          if (img.complete && img.naturalHeight !== 0) {
            (placeholder as HTMLElement).style.opacity = '0';
             setTimeout(() => placeholder.remove(), 300);
             img.classList.add('loaded');
             return;
          }

          img.style.opacity = '0';

          const handleLoad = () => {
            (placeholder as HTMLElement).style.opacity = '0';
            setTimeout(() => placeholder.remove(), 300);
            img.style.opacity = '1';
            img.classList.add('loaded');
          };

          const handleError = () => {
            placeholder.remove();
          };

          img.addEventListener('load', handleLoad);
          img.addEventListener('error', handleError);
        }
      });
    }

    // Run on initial load
    initLazyAvatars();

    // Run on view transitions
    document.addEventListener('astro:page-load', initLazyAvatars);
  </script>
)}

<style>
  .gravatar-avatar-wrapper {
    display: inline-block;
    vertical-align: middle;
    position: relative;
  }

  .gravatar-avatar {
    display: inline-block;
    vertical-align: middle;
    background-color: #f0f0f0;
    object-fit: cover;
    
    /* Smooth loading animation */
    transition: opacity 0.3s ease-in-out;
  }

  .lazy-placeholder {
    position: absolute;
    top: 0;
    left: 0;
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: skeleton-loading 1.5s ease-in-out infinite;
    transition: opacity 0.3s ease-in-out;
    pointer-events: none;
    z-index: 1;
  }

  .gravatar-avatar-wrapper[data-lazy="true"] .gravatar-avatar {
    opacity: 0;
    transition: opacity 0.3s ease-in-out;
  }

  .gravatar-avatar.loaded {
    opacity: 1;
  }

  @keyframes skeleton-loading {
    0% { background-position: -200% 0; }
    100% { background-position: 200% 0; }
  }

  /* Default rounded styles */
  .gravatar-avatar.rounded {
    border-radius: 0.25rem;
  }

  .gravatar-avatar.rounded-full {
    border-radius: 50%;
  }

  /* Dark mode support */
  @media (prefers-color-scheme: dark) {
    .gravatar-avatar {
      background-color: #2a2a2a;
    }
  }

  /* High contrast mode support */
  @media (prefers-contrast: high) {
    .gravatar-avatar {
      border: 1px solid currentColor;
    }
  }

  /* Reduced motion support */
  @media (prefers-reduced-motion: reduce) {
    .gravatar-avatar {
      transition: none;
    }
  }
</style>