name: Release

on:
  push:
    tags:
      - 'v*' # Trigger on version tags (v1.0.0, v1.0.1, etc.)
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Type of version bump'
        required: true
        default: 'patch'
        type: choice
        options:
        - patch
        - minor
        - major
        - prerelease
        - beta
        - alpha
      tag:
        description: 'Release tag (optional)'
        required: false
        type: string

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run tests
        run: bun run test

      - name: Run type checking
        run: bun run typecheck

      - name: Build package
        run: bun run build

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Extract version from tag
        id: version
        run: |
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            # Extract version from git tag (refs/tags/v1.2.3 -> 1.2.3)
            VERSION="${{ github.ref_name }}"
            VERSION=${VERSION#v} # Remove 'v' prefix
          else
            # Use manual input for workflow_dispatch
            VERSION_TYPE="${{ github.event.inputs.version_type }}"

            # Get current version and bump it
            CURRENT_VERSION=$(cd packages/astro-gravatar && cat package.json | jq -r '.version')
            echo "Current version: $CURRENT_VERSION"

            # Calculate new version
            if [[ "$VERSION_TYPE" == "major" ]]; then
              VERSION=$(cd packages/astro-gravatar && bun pm version major --no-git-tag-version | grep -o '[0-9]\+\.[0-9]\+\.[0-9]\+')
            elif [[ "$VERSION_TYPE" == "minor" ]]; then
              VERSION=$(cd packages/astro-gravatar && bun pm version minor --no-git-tag-version | grep -o '[0-9]\+\.[0-9]\+\.[0-9]\+')
            elif [[ "$VERSION_TYPE" == "patch" ]]; then
              VERSION=$(cd packages/astro-gravatar && bun pm version patch --no-git-tag-version | grep -o '[0-9]\+\.[0-9]\+[0-9]\+')
            elif [[ "$VERSION_TYPE" == "beta" ]]; then
              VERSION=$(cd packages/astro-gravatar && bun pm version preminor --preid beta --no-git-tag-version | grep -o '[0-9]\+\.[0-9]\.[0-9]\+-beta.[0-9]\+')
            elif [[ "$VERSION_TYPE" == "alpha" ]]; then
              VERSION=$(cd packages/astro-gravatar && bun pm version preminor --preid alpha --no-git-tag-version | grep -o '[0-9]\+\.[0-9]\.[0-9]\+-alpha.[0-9]\+')
            else
              VERSION=$(cd packages/astro-gravatar && bun pm version prerelease --no-git-tag-version | grep -o '[0-9]\+\.[0-9]\.[0-9]\+-[0-9]\+')
            fi
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=${{ github.event.inputs.tag || latest }}" >> $GITHUB_OUTPUT

      - name: Update package.json version
        run: |
          cd packages/astro-gravatar
          echo "Setting version to ${{ steps.version.outputs.version }}"
          bun pm pkg set version="${{ steps.version.outputs.version }}"
          echo "Updated package.json version to $(cat package.json | jq -r '.version')"

      - name: Determine release tag
        id: release_tag
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          if [[ "$VERSION" == *"beta"* ]]; then
            RELEASE_TAG="beta"
          elif [[ "$VERSION" == *"alpha"* ]]; then
            RELEASE_TAG="alpha"
          elif [[ "$VERSION" == *"rc"* ]]; then
            RELEASE_TAG="next"
          else
            RELEASE_TAG="latest"
          fi

          echo "release_tag=$RELEASE_TAG" >> $GITHUB_OUTPUT

      - name: Create git tag and commit
        if: ${{ github.ref_type != 'tag' }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          git add packages/astro-gravatar/package.json
          git commit -m "chore(release): bump version to $VERSION"
          git tag -a "v$VERSION" -m "Release v$VERSION"
          git push origin main --follow-tags

      - name: Generate changelog
        id: changelog
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          # Get previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          # Generate changelog
          if [ -n "$PREV_TAG" ]; then
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" $PREV_TAG..HEAD)
          else
            CHANGELOG=$(git log --pretty=format:"- %s (%h)")
          fi

          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Publish to npm
        id: publish
        run: |
          cd packages/astro-gravatar

          echo "Publishing with tag: ${{ steps.release_tag.outputs.release_tag }}"

          if [[ "${{ steps.release_tag.outputs.release_tag }}" == "latest" ]]; then
            bun publish
          else
            bun publish --tag ${{ steps.release_tag.outputs.release_tag }}
          fi

          echo "Published successfully!"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: Release v${{ steps.version.outputs.version }}
          body: |
            ## Changes in v${{ steps.version.outputs.version }}

            ${{ steps.changelog.outputs.changelog }}

            ### Installation
            \```bash
            bun add astro-gravatar
            # or
            npm install astro-gravatar
            \```

            ### Documentation
            Visit [astro-gravatar.and.guide](https://astro-gravatar.and.guide) for full documentation.
          draft: false
          prerelease: ${{ steps.release_tag.outputs.release_tag != 'latest' }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update CHANGELOG.md
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          CHANGELOG="${{ steps.changelog.outputs.changelog }}"
          TODAY=$(date +%Y-%m-%d)

          # Update CHANGELOG.md
          if [ -f CHANGELOG.md ]; then
            # Insert after the header
            awk -v entry="## [$VERSION] - $TODAY\n\n$CHANGELOG\n\n" '/^# Changelog$/ {print; print entry; next} 1' CHANGELOG.md > CHANGELOG.tmp && mv CHANGELOG.tmp CHANGELOG.md
          else
            # Create new changelog
            echo -e "# Changelog\n\n## [$VERSION] - $TODAY\n\n$CHANGELOG\n" > CHANGELOG.md
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add CHANGELOG.md
          git commit -m "docs: update changelog for v$VERSION"
          git push origin main

      - name: Trigger documentation update (if public release)
        if: steps.release_tag.outputs.release_tag == 'latest'
        run: |
          # This would trigger a separate workflow to update the documentation site
          echo "Public release v${{ steps.version.outputs.version }} - documentation update can be triggered here"